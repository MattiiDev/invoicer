<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:c="http://java.sun.com/jsp/jstl/core">

    <ui:composition>              
        <h:form prependId="false"> 
            <div class="right-tab" >                
                <h:commandLink action="#{invoiceCtrl.save}" styleClass="sidebar-right-round">                    
                    <h:graphicImage id="save-img1" styleClass="save-img"  url="/resources/images/check_black.png" alt="Save"/>
                    <p:tooltip for="save-img1" value="Save Invoice" />
                </h:commandLink>
                <h:commandLink action="list.jsf?faces-redirect=true" styleClass="sidebar-right-round" style="margin-top:75px;margin-right:-50px">
                    <h:graphicImage id="cancel-img" class="cancel-img" url="/resources/images/cancel_black.png" alt="Cancel"/>
                    <p:tooltip for="cancel-img" value="Cancel Edit Invoice" />
                </h:commandLink> 
            </div>

            <p:panel id="invoicePanel" styleClass="noBorder" style="width:100%;color: #1584de;background: #e6e6e6 url('');">
                <p:focus context="invoicePanel"/> 
                <h:panelGrid width="100%" columns="1" >  
                    <h:panelGroup layout="block" style="text-align: center;" styleClass="label5 textAlignRight noBorder">
                        <h:outputText value="Invoice #" />
                        <h:panelGroup>
                            <h:outputText id="invoiceId" value="#{invoiceCtrl.current.invoiceId} - " styleClass="font20"/>
                            <h:inputText id="invoiceNum" value="#{invoiceCtrl.current.invoiceNum}" styleClass="font20"/>
                        </h:panelGroup>
                        </h:panelGroup>
                                        <p:separator style="margin: 5px 0 5px 0" />

                        <h:panelGroup layout="block" style="text-align: center;margin: auto auto;width: 98%; " styleClass="borderRound10 floatLeft viewInfo" >
                            <h:panelGroup layout="block" style="float:left">
                        <h:outputText value="Date " styleClass="label3 textAlignRight" />
                        <p:calendar id="ordDateInp" effect="slideDown" navigator="true" showOn="button" pagedate=""
                                    mode="popup" autocomplete="true" value="#{invoiceCtrl.current.invoiceDate}"
                                    showButtonPanel="true" pattern="EEE, dd MMM, yyyy"/> 
                        </h:panelGroup>
                        <h:panelGroup layout="block" style="float:right">
                            <h:outputText value="Status" styleClass="label3 padRight10" />
                            <h:outputText value="#{workOrderCtrl.current.statusDisplay}" style="color:#{workOrderCtrl.current.statusColor}; " styleClass="font16 bold" />
                        </h:panelGroup>
                    </h:panelGroup>
                    <h:panelGroup id="customerPanelGroup">
                        <h:panelGrid width="49%" columns="1" columnClasses="noBorder label1 width20pr, noBorder width80pr" styleClass="borderRound10 floatLeft viewInfo" style="height: 140px">
                            <h:panelGroup>
                                <p:outputLabel value="Customer" for="custSugg" styleClass="label1"/>
                                <p:commandButton id="changeCusBtn" image="change-cust-image"  ajax="true"  rendered="#{not empty invoiceCtrl.current.customerId}"
                                                 style="font-size: 9px!important;margin-left: 10px; background:url('../resources/images/edit_pen-20.png') no-repeat; background-size: 16px 16px" title="Change"
                                                 actionListener="#{invoiceCtrl.changeCustomer}" update="customerPanelGroup" >
                                </p:commandButton>
                                <p:commandButton id="addCusBtn" image="add-cust-image" onclick="addCusPopup.show()" ajax="true" rendered="#{empty invoiceCtrl.current.customerId}"
                                                 style="font-size: 9px!important;margin-left: 10px; background:url('../resources/images/person_add-20.png') no-repeat" title="Add"
                                                 update="customerPanelGroup"/>
                            </h:panelGroup>
                            <h:panelGroup rendered="#{empty invoiceCtrl.current.customerId}">
                                <p:autoComplete id="custSugg" value="#{invoiceCtrl.current.customerId}" completeMethod="#{customerController.suggestCustomer}"  
                                                var="cust" itemLabel="#{cust.firstName}" dropdown="true" itemValue="#{cust}" size="50"
                                                queryDelay="2">                                        
                                    <p:column>  
                                        <f:facet name="header">
                                            <h:outputText value="Customer Name" styleClass="bold"/>
                                        </f:facet>
                                        <h:outputText value="#{cust.firstName} #{cust.lastName}"/> 
                                    </p:column> 
                                    <p:column>  
                                        <f:facet name="header">
                                            <h:outputText value="Company Name" styleClass="bold"/>
                                        </f:facet>
                                        <h:outputText value="#{cust.companyName}"/> 
                                    </p:column>
                                    <p:column>  
                                        <f:facet name="header">
                                            <h:outputText value="Address" styleClass="bold"/>
                                        </f:facet>
                                        <h:outputText value="#{cust.addressLine1}"/> 
                                        <br/>
                                        <h:outputText value="#{cust.city}"/> 
                                        <h:outputText value=", " rendered="#{not empty cust.country}"/> 
                                        <h:outputText value="#{cust.country}"/> 
                                        <br/>
                                        <h:outputText value="#{cust.mobileNum}"/> 
                                    </p:column>  
                                    <f:ajax event="itemSelect" listener="#{invoiceCtrl.identifyVehicle}" render="customerPanelGroup"/>
                                </p:autoComplete>                                                                                      
                            </h:panelGroup>

                            <h:outputText styleClass="viewCust" value="#{invoiceCtrl.current.customerId.firstName} #{invoiceCtrl.current.customerId.lastName}" />                               
                            <h:outputText styleClass="viewCust" value="#{invoiceCtrl.current.customerId.companyName}" />                               
                            <h:outputText styleClass="viewCust" value="#{invoiceCtrl.current.customerId.addressLine1}" />
                            <h:outputText styleClass="viewCust" value="#{invoiceCtrl.current.customerId.city}" />
                            <h:outputText styleClass="viewCust" value=", " rendered="#{not empty invoiceCtrl.current.customerId.country}"/>
                            <h:outputText styleClass="viewCust" value="#{invoiceCtrl.current.customerId.country}" />
                            <h:outputText styleClass="viewCust" value="#{invoiceCtrl.current.customerId.mobileNum}" />

                        </h:panelGrid>

                        <h:panelGrid id="vehMainPanel" styleClass="borderRound10 floatRight viewInfo" style="height: 140px; width:49%"
                                     columnClasses="noBorder">
                            <h:panelGroup>
                                <p:outputLabel value="Vehicle" for="vehSugg" styleClass="label1"/>
                                <p:commandButton image="change-cust-image"  ajax="true"  rendered="#{invoiceCtrl.changeVehicleIndicator}"
                                                 style="font-size: 9px!important;margin-left: 10px; background:url('../resources/images/edit_pen-20.png') no-repeat; background-size: 16px 16px" title="Change"
                                                 update="vehMainPanel" action="#{invoiceCtrl.changeVehicle}" >
                                </p:commandButton>               
                            </h:panelGroup>
                            <h:panelGrid id="invVehPanel"  columns="2" 
                                         rendered="#{empty invoiceCtrl.current.vehicle and not empty invoiceCtrl.current.customerId and not empty invoiceCtrl.current.customerId.customerVehicles and not invoiceCtrl.addNewVechicle}"
                                         columnClasses="bold colWidth15 noBorder ,bold label1 colWidth15 noBorder " >

                                <p:autoComplete id="vehSugg" value="#{invoiceCtrl.current.vehicle}" completeMethod="#{invoiceCtrl.suggestVehicle}"  
                                                var="veh1" itemLabel="#{veh1.model}" dropdown="true" itemValue="#{veh1}" size="30"
                                                queryDelay="2"  panelStyle="cursor: pointer" >                                        
                                    <p:column>  
                                        <f:facet name="header">
                                            <h:outputText value="Year" styleClass="bold"/>
                                        </f:facet>
                                        <h:outputText value="#{veh1.year}"/> 
                                    </p:column> 
                                    <p:column>  
                                        <f:facet name="header">
                                            <h:outputText value="Make" styleClass="bold"/>
                                        </f:facet>
                                        <h:outputText value="#{veh1.make}"/> 
                                    </p:column> 
                                    <p:column>  
                                        <f:facet name="header">
                                            <h:outputText value="Model" styleClass="bold"/>
                                        </f:facet>
                                        <h:outputText value="#{veh1.model}"/> 
                                    </p:column>
                                    <p:column>  
                                        <f:facet name="header">
                                            <h:outputText value="VIN" styleClass="bold"/>
                                        </f:facet>
                                        <h:outputText value="#{veh1.vin}"/> 
                                    </p:column>  
                                    <f:ajax event="itemSelect" render="vehMainPanel" />
                                </p:autoComplete>  
                                <p:commandButton image="add-cust-image" ajax="true"
                                                 style="margin-left:10px;font-size: 9px!important;background:url('../resources/images/plus_black.png') no-repeat" title="Add"
                                                 actionListener="#{invoiceCtrl.initNewVehicleToInvoice}" update="vehMainPanel"/>

                                <p:spacer/>
                                <p:spacer/>
                                <p:spacer/>
                            </h:panelGrid>

                            <h:panelGrid id="invVehPanel1" columns="4" width="100%"
                                         rendered="#{not empty invoiceCtrl.current.vehicle and not invoiceCtrl.addNewVechicle}"
                                         columnClasses="bold noBorder colWidth25,noBorder ,bold noBorder label1 colWidth25, noBorder " 
                                         >
                                <h:outputLabel value="Year:" styleClass="viewCust"  />
                                <h:outputText value="#{invoiceCtrl.current.vehicle.year}" styleClass=""  />
                                <h:outputLabel value="Make:" styleClass="viewCust " />
                                <h:outputText value="#{invoiceCtrl.current.vehicle.make}" styleClass="" />
                                <h:outputLabel value="Model:" styleClass="viewCust " />
                                <h:outputText value="#{invoiceCtrl.current.vehicle.model}" styleClass="" />
                                <h:outputLabel value="VIN:" styleClass="viewCust" />
                                <h:outputText value="#{invoiceCtrl.current.vehicle.vin}" />                            
                                <h:outputLabel value="Mileage:" styleClass="viewCust" />
                                <h:inputText value="#{invoiceCtrl.current.vehicle.mileage}" />                            
                            </h:panelGrid>
                            <h:panelGrid id="invVehPanel2" columns="4" width="100%"
                                         rendered="#{invoiceCtrl.addNewVechicle}"
                                         columnClasses="bold noBorder colWidth15,noBorder ,bold noBorder label1 colWidth15, noBorder " 
                                         >
                                <h:outputLabel value="Year:" styleClass="viewCust"  />                               
                                <h:inputText value="#{invoiceCtrl.current.vehicle.year}" styleClass="" size="5" />
                                <h:outputLabel value="Make:" styleClass="viewCust " />
                                <h:inputText value="#{invoiceCtrl.current.vehicle.make}" styleClass="" disabled="true" size="5" />
                                <h:outputLabel value="Model:" styleClass="viewCust " />
                                <h:inputText value="#{invoiceCtrl.current.vehicle.model}" styleClass="" size="10"/>
                                <h:outputLabel value="Mileage:" styleClass="viewCust" />                                
                                <h:inputText value="#{invoiceCtrl.current.vehicle.mileage}" size="8"/>   
                                <h:outputLabel value="VIN:" styleClass="viewCust" />
                                <h:inputText value="#{invoiceCtrl.current.vehicle.vin}" size="17" />                            

                            </h:panelGrid>
                        </h:panelGrid>

                    </h:panelGroup>

                    <h:panelGrid width="100%" columns="1" columnClasses="noBorder label1 ,noBorder,noBorder label1" styleClass="borderRound10 viewInfo" >
                        <p:outputLabel value="Notes" for="invoiceNotes" styleClass="label1"/>

                        <p:inputTextarea id="invoiceNotes" value="#{invoiceCtrl.current.invoiceDetails}" cols="110" rows="4" style="font-size: 12px" />

                    </h:panelGrid>
                </h:panelGrid>
                <p:spacer height="10px"/> 
                <p:dataTable id="ordItemTable" style="width: 100%;" styleClass="invoiceItemClass" 
                             value="#{invoiceCtrl.current.invoiceItems}" var="invItem"
                             rowIndexVar="row">

                    <p:column >
                        <h:graphicImage value="Remove item" style="cursor: pointer;padding-top:5px" alt="Remove item" url="/resources/images/trash_grey.png">
                            <f:ajax event="click" listener="#{invoiceCtrl.removeOrderItem(invItem)}" render="ordItemTable" />
                        </h:graphicImage>
                    </p:column>
                    <p:column>  
                        <h:outputText value="#{row + 1}" style="font-size: 10px; color: steelblue" /> 
                    </p:column>  
                    <p:column headerText="Description" width="50%"  >
                        <h:panelGroup layout="block" style=" float: left; ">
                            <p:inputTextarea rows="1" cols="40" value="#{invItem.description}" rendered="#{invItem.addItem or (empty invItem.item and not empty invItem.description)}"/>

                            <p:autoComplete id="itemSugg" value="#{invItem.item}" completeMethod="#{itemController.suggestItem}" widgetVar="itemSuggComp"
                                            var="item1" itemLabel="#{invItem.description}" itemValue="#{item1}" dropdown="true" size="49" 
                                            rendered="#{not (invItem.addItem or (empty invItem.item and not empty invItem.description))}">  
                                <p:column>  
                                    <f:facet name="header">
                                        <h:outputText value="Category" styleClass="bold"/>
                                    </f:facet>
                                    <h:outputText value="#{item1.itemCategory}"/> 
                                </p:column>  
                                <p:column>  
                                    <f:facet name="header">
                                        <h:outputText value="Description" styleClass="bold"/>
                                    </f:facet>
                                    <h:outputText value="#{item1.description}"/> 
                                </p:column>  
                                <p:column>  
                                    <f:facet name="header">
                                        <h:outputText value="Cost" styleClass="bold"/>
                                    </f:facet>
                                    <h:outputText value="#{item1.unitPrice}"/> 
                                </p:column>  
                                <f:ajax event="itemSelect" listener="#{invoiceCtrl.populateItemOnInvoice(invItem)}" render="itemSugg itemAmtVal unitPrice"/>

                            </p:autoComplete>
                        </h:panelGroup>

                        <h:panelGroup layout="block" style=" float: right;margin-left: 1px">

                            <p:commandButton id="addItemBtn" image="add-btn-image" action="#{invoiceCtrl.addNewItemToInvoice(invItem)}"
                                             rendered="#{empty invItem.addItem or not invItem.addItem}"
                                             style="font-size: 9px!important; background:url('../resources/images/plus_grey.png') no-repeat; border: none" 
                                             title="Add" update="ordItemTable" >

                            </p:commandButton>
                        </h:panelGroup>

                        <h:panelGroup layout="block" style=" float: right;margin-left: 1px">

                            <p:commandButton id="undoAddItemBtn" image="add-btn-image" 
                                             rendered="#{invItem.addItem}" action="#{invoiceCtrl.undoAddItemToInvoice(invItem)}"
                                             style="font-size: 9px!important; background:url('../resources/images/undo.png') no-repeat; border: none" 
                                             title="Undo Add" update="ordItemTable"
                                             >
                            </p:commandButton>
                            <br/>
                            <p:selectBooleanCheckbox id="addItemCheckbox" value="#{invItem.addItem}" rendered="#{invItem.addItem}" 
                                                     style="font-size: 9px!important;"/>
                            <p:tooltip for="addItemCheckbox" value="Add to Item List" />
                        </h:panelGroup>
                    </p:column>
                    <p:column headerText="Qty" width="15%" >
                        <p:spinner value="#{invItem.quantity}" size="5" min="1" maxlength="5" >
                            <f:ajax event="change" listener="#{invoiceCtrl.calculateOrderItemPrice(invItem)}" execute="@this" render="itemAmtVal" />
                        </p:spinner>
                    </p:column>
                    <p:column headerText="Unit Price" width="25%" >
                        <p:spinner id="unitPrice" value="#{invItem.unitPrice}" size="8" min="1" maxlength="6"  >
                            <f:ajax event="change" listener="#{invoiceCtrl.calculateOrderItemPrice(invItem)}" execute="@this" render="itemAmtVal" />
                        </p:spinner>
                    </p:column>
                    <p:column headerText="Amount" width="20%" id="itmNetAmt" style="text-align:right;padding-right: 20px">
                        <h:outputText id="itemAmtVal" value="#{invItem.amount}" >
                        </h:outputText>
                    </p:column>                     
                    <f:facet name="footer"> 
                        <table class="invoiceTableFooter" cellpadding="0" cellspacing="0" width="100%">
                            <tfoot style="color:#2e6e9e">
                                <tr style="border-bottom: 1px solid lightsteelblue;" >
                                    <td style="float:left;" >
                                        <p:splitButton id="addRowBtn1" style="text-align: left" 
                                                         icon="ui-icon-plus" action="#{invoiceCtrl.addNewItemToInvoice}"                                                                         
                                                         update="ordItemTable" >
                                            <p:menuitem value="Add 5 rows below" ajax="true" actionListener="#{invoiceCtrl.addNewRowsToInvoice(5)}" update="ordItemTable">
                                                
                                            </p:menuitem>
                                            
                                        </p:splitButton>
                                    </td>
                                    <td >
                                        <span></span>
                                    </td>
                                    <td style="width:70%">
                                        <span></span>
                                    </td>
                                    <td style="width:20%;text-align: right">
                                        <h:outputText value="Subtotal"/>                                        
                                    </td>
                                    <td style="width:20%;text-align: right;">
                                        <p:outputPanel autoUpdate="true">
                                            <h:outputText value="#{invoiceCtrl.current.itemTotalAmount}"/>
                                        </p:outputPanel>
                                    </td>
                                </tr>                                
                                <tr>
                                    <td  style="width:60%">
                                        <span></span>
                                    </td>
                                    <td style="width:20%;text-align: right">
                                        <h:outputText value="Discount"/>
                                    </td>
                                    <td style="width:20%;text-align: right">
                                        <p:spinner value="#{invoiceCtrl.current.discount}" size="2" style="float:left;text-align: left" min="0" maxlength="6" >
                                            <f:ajax event="change" listener="#{invoiceCtrl.calOrderPrice}"  execute="@this" render="ordItemTable" />
                                        </p:spinner>
                                        <p:selectOneMenu styleClass="discountUom" style="font-size: 10px;padding:0;margin:0;text-align: left">
                                            <f:selectItem itemLabel="SAR" itemValue="currency" />
                                            <f:selectItem itemLabel="%" itemValue="percent"/>
                                        </p:selectOneMenu>
                                    </td>
                                    <td style="width:20%;text-align: right; font-size: 16px">
                                        <h:outputText value="Total"/>
                                    </td>                                    
                                    <td width="14%" style="width:20%;text-align: right;font-weight: bold;font-size: 16px; color:midnightblue">
                                        <p:outputPanel autoUpdate="true">
                                            <h:outputText id="totAmt" value="#{invoiceCtrl.current.amount}">
                                                <f:convertNumber currencyCode="SAR" maxFractionDigits="2" groupingUsed="true" type="currency" currencySymbol="SAR"/>
                                            </h:outputText>
                                        </p:outputPanel>
                                    </td>
                                </tr>
                            </tfoot>                                                      
                        </table>                           
                    </f:facet>                        
                </p:dataTable>                                             

                <p:commandButton style="font-size:22px;float: right;margin-top: 10px;vertical-align: middle " rendered="false" 
                                 action="#{invoiceCtrl.save}" value="#{source == 'createInvoice'? 'Create' : 'Save'}" icon="ui-icon-circle-check"  />

            </p:panel>

            <p:dialog id="addCustDg" header="New Customer" widgetVar="addCusPopup" modal="true" 
                      width="930" closeOnEscape="true" height="550" showEffect="clip" 
                      resizable="true">  
                <ui:include src="/customer/inc_createCustomer.xhtml">
                    <ui:param name="controller" value="#{invoiceCtrl.custCtrl}"/>
                </ui:include>

                <p:commandButton action="#{invoiceCtrl.addNewCustomerToInvoice}" value="#{bundle.CreateCustomerSaveLink}" 
                                 icon="ui-icon-disk" oncomplete="addCusPopup.hide();" />

                <p:ajax event="close" update="invoicePanel" />  
            </p:dialog> 

            <p:dialog id="addItemDg"  widgetVar="addItemPopup" modal="true" width="900" height="350" showEffect="clip">  
                <ui:include src="/item/inc_createItem.xhtml">
                    <ui:param name="controller" value="#{invoiceCtrl.itemCtrl}"/>
                </ui:include>

                <p:commandButton action="#{invoiceCtrl.createNewItemAndAddToInvoice}" value="Add Item" icon="ui-icon-disk" oncomplete="addItemPopup.hide();" 
                                 update="invoicePanel" />

                <p:ajax event="close" update="invoicePanel" /> 
            </p:dialog> 

            <p:remoteCommand name="addNewCust" update="invoicePanel" action="#{invoiceCtrl.addNewCustomerToInvoice}"/>  

        </h:form>               
    </ui:composition>
</html>
